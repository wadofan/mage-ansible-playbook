# Ansible Playbook для SCIFiC

Проект був розроблений в рамках дипломної роботи та призначений
для автоматизованого налаштування віддаленого сервера, а також
для завантаження і запуску [іншого проекта](https://github.com/wadofan/mage-docker).


## Як користуватись цим проектом?

Варто зазначити, що в проекті використовуються деякі колекції,
що не входять в базову комплектацію Ansible (`ansible-core`).
Тому може виникнути необхідність встановити їх за допомогою
команди:

```console
$ ansible-galaxy collection install ansible.posix community.general community.docker
```

Проект складається з двох плейбуків: `init.yml` та `run.yml`.
Перший виконує початкове налаштування сервера, а другий
призначений для завантаження і запуску іншого Docker-проекта.
Їх потрібно виконувати по черзі, хоча це можна зробити і в
одній команді:

```console
$ ansible-playbook ./init.yml ./run.yml
```

Також, перед виконанням плейбуків, слід переглянути визначені
змінні (див. далі по тексту) та, за потреби, змінити їх.
Крім цього, слід визначити перелік віддалених хостів, а також
додаткові параметри для доступу до них.


## Опис ролей в плейбуці

- `system`: призначена для початкового налаштування
операційної системи на сервері: оновлення і встановлення
пакетів, а також для створення коритувача;

- `docker`: призначена для встановлення інструментів Docker
(на даний момент розрахована в основному на ОС Debian 12);

- `harden`: призначена для забезпечення базової безпеки на
сервері: налаштування демона SSH, встановлення і налаштування
брендмауера (`ufw`), а також блокування доступу до облікового
запису користувача `root`;

- `scific`: призначена для завантаження і запуску Docker-проекта.


## Налаштування параметрів

Налаштування загальних параметрів Ansible відбувається
у конфігураційному файлі `ansible.cfg` (або локально в 
директорії проекта, або глобально у файлі `/etc/ansible/ansible.cfg`).
Приклад конфігурації наведений у файлі `ansible.cfg.example`;

Перелік віддалених хостів, до яких буде під'єднуватись Ansible,
зазвичай визначається у файлі інвентарю (також, або локально в 
директорії проекта, або глобально у файлі `/etc/ansible/hosts`).
В тому ж файлі можна визначити параметри для доступу до хостів,
такі як ім'я користовуча, пароль або SSH-ключ. Приклад файла
інвентаря наведений в у файлі `hosts.example`;

Значення для змінних можна визначати у файлах `roles/<роль>/vars/main.yml`
для кожної ролі окремо, або у загальному файлі `group_vars/all/vars.yml`,
а також безпосередньо під час виконання команди `ansible-playbook`,
використовуючи аргументи командного рядка.

Крім цього, значення деяких змінних можуть задаватись за
допомогою наступних змінних із середовища командного рядка:
- `$MAGE_USER` задає значення для змінної `mage_user_name`,
- `$MAGE_PASS` задає значення для змінної `mage_user_pass`,
- `$MAGE_SHELL` задає значення для змінної `mage_user_shell`,
- `$MAGE_EMAIL` задає значення для змінної `letsencrypt_email`,
- `$MAGE_DOMAIN` задає значення для змінної `letsencrypt_domain`.


## Перелік змінних

### Загальні змінні

| Назва                | Опис                                                                             |
| :------------------- | :------------------------------------------------------------------------------- |
| `letsencrypt_domain` | доменне ім'я, для якого буде виданий SSL-сертифікат                              |
| `letsencrypt_email`  | електронна пошта, на яку буде зареєстрований SSL-сертифікат                      |
| `mage_user_key`      | SSH-ключ для доступу до користувача (за замовчуванням з файла `~/.ssh/mage.pub`) |
| `mage_user_name`     | Ім'я користувача, що буде створений на сервері (за замовчуванням "`mage`")       |
| `mage_user_pass`     | Пароль для доступу до користувача (за замовчуванням "`changeme`")                |
| `mage_user_shell`    | Командний інтерпритатор для користувача (за замовчуванням "`/usr/bin/bash`")     |
| `project_dir`        | Директорія для завантантаження Docker-проекта                                    |

### Для ролі system

| Назва      | Опис                                            |
| :--------- | :---------------------------------------------- |
| `cron_pkg` | Назва пакета cron  (за замовчуванням "`cron`") |
| `gpg_pkg`  | Назва пакета GnuPG (за замовчуванням "`gnupg`") |
| `sudo_pkg` | Назва пакета sudo  (за замовчуванням "`sudo`")  |

### Для ролі docker

| Змінна               | Опис                                             |
| :------------------- | :----------------------------------------------- |
| `apt_docker_keyfile` | Шлях до файла з GPG-ключем Docker для Apt        |
| `cpu_arch`           | Архітектура процесора (наприклад, "`amd64`")     |
| `debian_release`     | Назва версії ОС Debian (наприклад, "`bookworm`") |

### Для ролі harden

| Змінна        | Опис                                          |
| :------------ | :-------------------------------------------- |
| `ssh_service` | Назва демона SSH (за замовчуванням "`sshd`")  |
| `ufw_pkg`     | Назва пакета UFW (за замовчуванням "`ufw`")   |

### Для ролі scific

| Змінна                 | Опис                                                    |
| :--------------------- | :------------------------------------------------------ |
| `compose_repo`         | URL репозиторія з Docker-проектом                       |
| `cron_file`            | Назва для файла із задачами cron                        |
| `cron_service`         | Назва демона cron (за замовчуванням "`crond`")          |
| `git_pkg`              | Назва пакета Git (за замовчуванням "`git`")             |
| `ssh_pkg`              | Назва пакета SSH-клієнта (за замовчуванням "`openssh`") |
| `website_repo`         | URL репозиторія з файлами вебсайту                      |
