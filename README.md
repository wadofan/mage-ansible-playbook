# Ansible Playbook для SCIFiC

Проект призначений для автоматизованого налаштування новоствореного сервера, а також
завантаження і запуску на ньому [іншого](https://github.com/wadofan/mage-docker) проекта.


## Як користуватись цим плейбуком?

Для того, щоб запустити виконання плейбука, необхідно,
вказавши за потреби додаткові параметри та змінні 
(див. далі по тексту), виконати наступну команду:

```console
$ ansible-playbook ./playbook.yml
```

Крім цього, в проекті використовуються деякі колекції, що не входять 
в базову комплектацію Ansible (ansible-core). Тому перед виконанням
плейбука необхідно встановити їх за допомогою команди:

```console
$ ansible-galaxy collection install  ansible.posix community.general community.docker
```


## Перелік змінних

Крім змінних, що використовуються у ролях 
і будуть розглянуті нижче, існують також 
групові змінні що знаходяться у файлі 
`group_vars/all/vars.yml` і використовуються 
для всього проекту.

| Назва                | Опис                                           |
| :------------------- | :--------------------------------------------- |
| `project_user_name`  | Ім'я користувача, для нової системи            |
| `project_user_pass`  | Пароль для доступу до того ж  користувача      |
| `project_user_shell` | Командний інтерпритатор для того ж користувача |
| `project_user_key`   | SSH ключ для доступу до того ж користувача     |
| `project_dir`        | Директорія для завантантаження проекта         |

Роль `system` призначення для початкового налаштування
операційної системи на новому сервері: оновлення і 
встановлення пакетів, а також для створення коритувача.

Для цього використовуються такі змінні:

| Назва      | Опис                                           |
| :--------- | :--------------------------------------------- |
| `gpg_pkg`  | Назва пакета GnuPG (за замовчуванням "`gpg`")  |
| `cron_pkg` | Назва пакета cron  (за замовчуванням "`cron`") |
| `sudo_pkg` | Назва пакета sudo  (за замовчуванням "`sudo`") |

Роль `docker` призначена для встановлення Docker і 
поки що, заточена під ОС Debian 12, у зв'язку з цим, 
вона містить змінні, що дозволяють визначити специфічні 
для цієї операційної системи параметри:

| Змінна               | Опис                                                                  |
| :------------------- | :-------------------------------------------------------------------- |
| `debian_release`     | Назва версії ОС Debian (наприклад, "`bookworm`")                      |
| `cpu_arch`           | Архітектура процесора (наприклад, "`amd64`")                          |
| `apt_docker_keyfile` | Шлях до файлу, що містить GPG ключ Docker для пакетного менеджера Apt |

Роль `harden` призначенна забезпечення безпеки
на нових серверах, а саме: налаштування демона
SSH, встановлення і налаштування брендмауера 
(був обраний `ufw`), а також блокування доступу
до облікового запису користувача `root`.

| Змінна        | Опис                                         |
| :------------ | :------------------------------------------- |
| `ufw_pkg`     | Назва пакета UFW (за замовчуванням "`ufw`")  |
| `ssh_service` | Назва сервіса SSH (за замовчуванням "`sshd`")|

Для завантаження і запуску проекта були створені 
ролі `github` і `scific`. Вони використовують 
наступні змінні:

| Змінна              | Опис |
| :------------------ | :--- |
| `git_pkg`           | Назва пакета Git (за замовчуванням "`git`")             |
| `ssh_pkg`           | Назва пакета SSH-клієнта (за замовчуванням "`openssh`") |
| `local_keyfile`     | Шлях до файлу (на локальній машині) з приватним ключем SSH для доступу до закритого GitHub репозиторію  |
| `remote_keyfile`    | Шлях до файлу (на віддаленій машині) з приватним ключем SSH для доступу до закритого GitHub репозиторію |
| `project_repo`      | URL репозиторія з Docker-проектом  |
| `website_repo`      | URL репозиторія з файлами вебсайту |

| Змінна                 | Опис |
| :--------------------- | :--- |
| `cron_service`         | Назва сервіса cron (за замовчуванням "`crond`")        |
| `cron_file`            | Назва для файлу із задачами cron |
| `nginx_container_name` | Назва контейнера Nginx           |
| `letsencrypt_email`    | електрона пошта, на яку буде зареєстрований сертифікат |
| `letsencrypt_domain`   | доменне ім'я, на яке буде виданий сертифікат           |

Також варто згадати, що деякі змінні, хоча це не обов'язково,
задаються за допомогою змінних середовища. Можна задати ці 
змінні у вашому середовищі або змінити їх напряму у файлах.

Наприклад, у файлі `group_vars/all/vars.yml`
змінна `project_user_pass` задається за
допомогою змінної середовища `MAGE_PASS`.

У файлі `roles/scific/vars/main.yml`:
- `MAGE_EMAIL` задає змінну `letsencrypt_email`
- `MAGE_DOMAIN` задає змінну `letsencrypt_domain`


## Як можна задати ці параметри?

- у конфігураційному файлі `ansible.cfg` (або глобально в `/etc/ansible/ansible.cfg`, 
або в локальному файлі, приклад якого наданий в корені проекту як `ansible.cfg.example`);

- у файлі інвентарю зазвичай вказується список хостів (у вигляді IP-адрес або 
доменних імен), але там також можна вказати змінні для окремих хостів або
для групи. Аналогічно можна скористатись глобальним файлом `/etc/ansible/hosts` 
або локальним, приклад якого наданий в корені проекту як `inventory.example`;

- у файлах змінних;

- безпосередньо під час виконання команди (за допомогою аргументів командного рядка).

