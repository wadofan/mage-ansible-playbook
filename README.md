# Ansible Playbook'и для SCIFiC

## Что стоит учесть

Для указания настроек Ansible используется конфигурационный файл `/etc/ansible/ansible.cfg`,
а также так называемый инвентарь `/etc/ansible/hosts`, в котором указывается список IP-адресов
или доменных имен серверов. Настройки можно также указать и в других, более локальных файлах,
например, в папке с этим проектом лежит файл `ansible.cfg.example`, который является примером
локального файла конфигурации Ansible. Убрав окончание ".example" и изменив содержимое файла
на то, которое больше подходит под условия среды, получим локальный конфиг, при запуске Ansible
из этой папки он будет иметь приоритет над глобальным.

Переменные указываются в файле конфигурации, как это сделано в файле `ansible.cfg.example`,
или инвентаре, так как показано в файле `inventory.example`. Их также можно группировать,
в примере файла инвентаря в секции `all:vars` заданы переменные с ключем и паролем `sudo`
для серверов из группы `all` (всех серверов). Переменные можно также указывать отдельно
к каждому хосту, для этого они задаются через пробел в формате `ключ=значение` после
IP-адреса или доменного имени хоста в инвентаре, это также показано в файле `inventory.example`.

Команды установки Docker на системе Debian, которые выполняет Ansible из плейбука `docker.yml`,
требуют прав суперпользователя. Для того, чтобы задать такой пароль, используется переменная
`ansible_become_password`, которую можно задать в конфигурации или инвентаре. Это не актуально,
если вход в систему производится от имени пользователя `root`, а также, если для пользователя
с помощью `sudo` настроено выполнение любых или используемых в плейбуке команд без пароля.

Плейбуки `docker.yml` для установки Docker в систему Debian и `scific.yml` для скачивания
другого проекта с GitHub вынесены в отдельный каталог. Их можно вызывать по отдельности,
указав при вызове команды путь до них, или воспользоваться файлом `playbook.yml`, в котором
они подключены и должны, по идее, выполняться как запланировано по очереди.

Для установки пакетов на первом этапе плейбука `scific.yml` используется модуль `ansible.builtin.package`,
который может устанавливать пакеты на различных системах, обращаясь к их пакетным менеджерам.
Но имена пакетов на разных системах могут отличатся, поэтому была предусмотрена возможность
задать имена пакетов для машин (или групп) через инвентарь. Для этого используются переменные: 
`git_pkg` для пакета Git, а также `ssh_pkg` для пакета OpenSSH. Если имена этих пакетов в системе 
не отличаются от заданых в плейбуке по умолчанию (`git` и `openssh`), то их можно не указывать.

<!--
Поэтому, если установлена базовая комплектация Ansible (`ansible-core`), сначала эти модули
нужно скачать из Ansible Galaxy, используя команду:

```console
$ ansible-galaxy collection install community.general community.docker
```
-->

## Как использовать

Изменить `/etc/ansible/hosts` или какой-нибудь другой файл инвентаря (локальным инвентарем
для этого проекта файл является `inventory`, который получается, если убрать лишнее окончание
у файла `inventory.example`). В нём нужно указать список хостов, которые можно сгруппировать,
а также данные для входа в систему, которые задаются переменными `ansible_user` и `ansible_pass`.
Чтобы использовать локальный файл инвентаря можно использовать ключ `-i` при вызове команды
или указать его в `ansible.cfg`. Если же для входа по SSH используется связка ключей, необходимо
указать путь к такому ключу в конфигурации, используя переменную `ansible_ssh_private_key_file`,
или при запуске вызове команды с помощью параметра `--private-key`.

Если пользователь, от имени которого Ansible входит в систему, требует пароль для использования
команд через `sudo`, его можно также задать в файлах конфигурации или использовать параметр
`--ask-become-pass` (ключ `-K`) при запуске плейбука.

<!--
К тому же, если пользователя необходимо добавить в группу `docker`, чтобы он имел возможность
запускать контейнеры, а также использовать любые другие команды Docker без использования `sudo`,
необходимо в инвентаре или при запуске плейбука задать переменную `docker_user`, содержащую
имя такого пользователя.
-->

Таким образом, для запуска плейбука с использованием локального файла инвентаря и запросом
на ввод пароля `sudo`, а также пароля для входа как пользователь `<user>`, нужно выполнить
подобную команду:

```console
$ ansible-playbook playbook.yml -K -i ./inventory -u <user> -k
```

Если же все необходимые параметры настроены в `ansible.cfg` и/или в инвентаре,
выполнение команды сводится до простого указания плейбука:

```console
$ ansible-playbook playbook.yml
```
