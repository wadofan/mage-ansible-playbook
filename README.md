# Ansible Playbook'и для SCIFiC

## Что стоит учесть

Для указания настроек Ansible используется конфигурационный файл `/etc/ansible/ansible.cfg`, 
а также так называемый инвентарь `/etc/ansible/hosts`, в котором указывается список IP-адресов 
или доменных имен серверов. Настройки можно также указать и в других, более локальных файлах, 
например, в папке с этим проектом лежит файл `ansible.cfg.example`, который является примером 
локального файла конфигурации Ansible. Убрав окончание ".example" и изменив содержимое файла 
на то, которое больше подходит под условия среды, получим локальный конфиг, при запуске Ansible 
из этой папки он будет иметь приоритет над глобальным.

Переменные указываются в файле конфигурации, как это сделано в файле `ansible.cfg.example`, 
или инвентаре, так как показано в файле `inventory.example`. Их также можно группировать, 
в примере файла инвентаря в секции `group:vars` заданы переменные с данными для подключения 
к серверам из группы `group`. Переменные можно также указывать отдельно для каждого хоста, 
для этого они задаются через пробел в формате `ключ=значение` после IP-адреса или доменного 
имени хоста в инвентаре, это также показано в файле `inventory.example`.

Команды установки Docker на системе Debian, которые выполняет Ansible из плейбука `docker.yml`, 
требуют прав суперпользователя. Для того, чтобы задать такой пароль, используется переменная 
`ansible_become_password`, которую можно задать в конфигурации или инвентаре. Это не актуально, 
если вход в систему производится от имени пользователя `root`, а также, если для пользователя 
с помощью `sudo` настроено выполнение любых или используемых в плейбуке команд без пароля.  


## Как использовать

Изменить `/etc/ansible/hosts` или какой-нибудь другой файл инвентаря (локальным инвентарем 
для этого проекта файл является `inventory`, который получается, если убрать лишнее окончание 
у файла `inventory.example`). В нём нужно указать список хостов, которые можно сгруппировать, 
а также данные для входа в систему, которые задаются переменными `ansible_user` и `ansible_pass`. 
Чтобы использовать локальный файл инвентаря можно использовать ключ `-i` при вызове команды или 
указать его в `ansible.cfg`.

Если пользователь, от имени которого Ansible входит в систему, требует пароль для использования
команд через `sudo`, его можно также задать в файлах конфигурации или использовать параметр 
`--ask-become-pass` (ключ `-K`) при запуске плейбука.

Если для входа по SSH используется связка криптографических ключей, указать путь к такому ключу 
в конфигурации, используя переменную `private_key_file`, или при запуске вызове команды с помощью 
параметра `--private-key`.

К тому же, если пользователя необходимо добавить в группу `docker`, чтобы он имел возможность 
запускать контейнеры, а также использовать любые другие команды Docker без использования `sudo`,
необходимо в инвентаре или при запуске плейбука задать переменную `docker_user`, содержащую 
имя такого пользователя.

Таким образом, для запуска плейбука с использованием локального файла инвентаря и запросом на 
ввод пароля `sudo`, а также добавлением пользователя `user` в группу `docker`, нужно выполнить 
подобную команду:

```console
$ ansible-playbook ./docker.yml -K -i ./inventory -e "docker_user=user"
```

Если же все необходимые параметры настроены в `ansible.cfg` и/или в инвентаре, 
выполнение команды сводится до простого указания плейбука:

```console
$ ansible-playbook ./docker.yml
```
