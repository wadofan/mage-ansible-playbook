---

- name: Check if needed tools are installed
  hosts: all
  become: true
  become_method: ansible.builtin.sudo
  pre_tasks:

    - name: Set git package name
      set_fact: git_pkg="git"
      when: git_pkg is undefined

    - name: Set openssh package name
      set_fact: ssh_pkg="openssh"
      when: ssh_pkg is undefined
    
    - name: Ensure git and openssh are installed
      ansible.builtin.package:
        name:
          - "{{ git_pkg }}"
          - "{{ ssh_pkg }}"
        state: present

- name: Download project from GitHub
  hosts: all
  vars:
    keyfile_path: "~/.ssh/github"
    project_dir: "~/mage-docker"
    project_repo: "git@github.com:wadofan/mage-docker.git"
    scific_repo: "https://github.com/scific-conference/scific.git"
  tasks:

    - name: Check if SSH key exist
      ansible.builtin.stat:
        path: "{{ keyfile_path }}"
      register: sshkey

    - name: Copy SSH key for GitHub (if not exist)
      ansible.builtin.copy:
        src: ../keys/github
        dest: "{{ keyfile_path }}"
        mode: '0600'
      when: not sshkey.stat.exists

    - name: Clone repository from GitHub
      ansible.builtin.git:
        key_file: "{{ keyfile_path }}"
        accept_hostkey: true
        repo: "{{ project_repo }}"
        dest: "{{ project_dir }}"
        version: main
        single_branch: true

    - name: Clone SCIFiC repository
      ansible.builtin.git:
        repo: "{{ scific_repo }}"
        dest: "{{ project_dir }}/scific"
        version: main
        single_branch: true
